<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>购物清单管理</title>
	<style>
		:root {
			--bg: #f7f8fa;
			--panel: #ffffff;
			--text: #1f2937;
			--muted: #6b7280;
			--border: #e5e7eb;
			--primary: #2563eb;
			--primary-hover: #1d4ed8;
			--danger: #ef4444;
			--danger-hover: #dc2626;
			--success: #16a34a;
			--warning: #d97706;
		}
		* { box-sizing: border-box; }
		body {
			margin: 0;
			background: var(--bg);
			color: var(--text);
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
				Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
				"Source Han Sans SC", sans-serif;
			line-height: 1.5;
		}
		.container {
			max-width: 980px;
			margin: 32px auto;
			padding: 0 16px;
		}
		.header {
			margin-bottom: 16px;
		}
		h1 {
			margin: 0 0 8px 0;
			font-size: 22px;
		}
		.subtle {
			color: var(--muted);
			font-size: 14px;
		}
		.panel {
			background: var(--panel);
			border: 1px solid var(--border);
			border-radius: 12px;
			box-shadow: 0 1px 2px rgba(0,0,0,0.04);
			overflow: hidden;
		}
		.form-row {
			display: grid;
			grid-template-columns: 2fr 1.4fr 1.4fr 1fr auto;
			gap: 12px;
			padding: 16px;
			border-bottom: 1px solid var(--border);
		}
		@media (max-width: 760px) {
			.form-row {
				grid-template-columns: 1fr 1fr;
			}
			.form-row .full {
				grid-column: 1 / -1;
			}
		}
		label {
			display: block;
			font-size: 12px;
			color: var(--muted);
			margin-bottom: 6px;
		}
		input[type="text"], input[type="number"], select {
			width: 100%;
			height: 36px;
			padding: 6px 10px;
			border: 1px solid var(--border);
			border-radius: 8px;
			background: #fff;
			color: var(--text);
			outline: none;
			transition: border-color .15s ease;
		}
		input[type="text"]:focus, input[type="number"]:focus, select:focus {
			border-color: var(--primary);
		}
		actions, .actions {
			display: flex;
			align-items: flex-end;
		}
		button {
			height: 36px;
			padding: 0 14px;
			border: 1px solid transparent;
			border-radius: 8px;
			background: var(--primary);
			color: #fff;
			font-size: 14px;
			cursor: pointer;
			transition: background .15s ease, opacity .15s ease;
		}
		button:hover { background: var(--primary-hover); }
		button.secondary {
			background: #fff;
			color: var(--text);
			border-color: var(--border);
		}
		button.danger {
			background: var(--danger);
		}
		button.danger:hover {
			background: var(--danger-hover);
		}
		.table-wrapper {
			overflow-x: auto;
		}
		table {
			width: 100%;
			border-collapse: collapse;
			min-width: 760px;
		}
		thead th {
			text-align: left;
			font-weight: 600;
			color: var(--muted);
			background: #fafafa;
			border-bottom: 1px solid var(--border);
			padding: 12px;
			font-size: 13px;
			white-space: nowrap;
		}
		tbody td {
			border-bottom: 1px solid var(--border);
			padding: 12px;
			vertical-align: middle;
			font-size: 14px;
		}
		tbody tr:hover {
			background: #fcfcfc;
		}
		nowrap { white-space: nowrap; }
		.badge {
			display: inline-block;
			padding: 2px 8px;
			border-radius: 999px;
			font-size: 12px;
			white-space: nowrap;
		}
		.badge.success { background: #ecfdf5; color: var(--success); }
		.badge.warning { background: #fffbeb; color: var(--warning); }
		.badge.muted { background: #f3f4f6; color: #374151; }
		.footer-area {
			display: flex;
			flex-wrap: wrap;
			justify-content: space-between;
			gap: 8px 12px;
			align-items: center;
			padding: 12px 16px;
			border-top: 1px solid var(--border);
		}
		.footer-note {
			font-size: 12px;
			color: var(--muted);
		}
		.totals {
			font-size: 14px;
			color: var(--text);
		}
		.totals .num {
			font-variant-numeric: tabular-nums;
			font-weight: 600;
			margin: 0 4px;
		}
		.row-status-select {
			min-width: 132px;
		}
		.row-category, .row-subcategory {
			white-space: nowrap;
		}
		.price-cell {
			text-align: right;
			font-variant-numeric: tabular-nums;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h1>购物清单管理</h1>
			<div class="subtle">添加你的清单条目，选择需求类别与子类别，按需标记状态为“待决策 / 已购买 / 已放弃”。</div>
		</div>

		<div class="panel">
			<div class="form-row">
				<div>
					<label for="itemName">商品名称</label>
					<input id="itemName" type="text" placeholder="例如：电动牙刷" />
				</div>
				<div>
					<label for="category">需求类别</label>
					<select id="category">
						<option value="" selected>请选择</option>
						<option value="刚需">刚需（Essential Needs）</option>
						<option value="计划性需求">计划性需求（Planned Needs）</option>
						<option value="冲动性需求">冲动性需求（Impulsive Needs）</option>
					</select>
				</div>
				<div>
					<label for="subcategory">子类别</label>
					<select id="subcategory" disabled>
						<option value="">先选择上方类别</option>
					</select>
				</div>
				<div>
					<label for="price">价格</label>
					<input id="price" type="number" min="0" step="0.01" placeholder="0.00" />
				</div>
				<div class="actions">
					<button id="addBtn">添加到清单</button>
				</div>
			</div>

			<div class="table-wrapper">
				<table>
					<thead>
						<tr>
							<th>商品名称</th>
							<th>需求类别</th>
							<th>子类别</th>
							<th class="nowrap">价格（¥）</th>
							<th>状态</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody id="listBody">
						<!-- 动态条目插入于此 -->
					</tbody>
				</table>
			</div>

			<div class="footer-area">
				<div class="totals">
					已购买：<span id="purchasedCount" class="num">0</span>项，
					合计：¥<span id="purchasedTotal" class="num">0.00</span>
				</div>
				<div class="footer-note">
					数据已自动本地保存；状态可在列表中直接更改；你也可以删除条目。
				</div>
			</div>
		</div>
	</div>

	<script>
		(function () {
			const STORAGE_KEY = "shoppingListV1";

			const categoryToSub = {
				"刚需": ["每月必要支出", "其他支出"],
				"计划性需求": ["心愿单", "其他"],
				"冲动性需求": []
			};

			const els = {
				itemName: document.getElementById("itemName"),
				category: document.getElementById("category"),
				subcategory: document.getElementById("subcategory"),
				price: document.getElementById("price"),
				addBtn: document.getElementById("addBtn"),
				listBody: document.getElementById("listBody"),
				purchasedCount: document.getElementById("purchasedCount"),
				purchasedTotal: document.getElementById("purchasedTotal")
			};

			let items = [];

			// ========== 本地存储 ==========
			function loadData() {
				try {
					const raw = localStorage.getItem(STORAGE_KEY);
					if (!raw) return [];
					const arr = JSON.parse(raw);
					if (!Array.isArray(arr)) return [];
					return arr;
				} catch {
					return [];
				}
			}

			function saveData() {
				try {
					localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
				} catch (e) {
					console.warn("无法保存到本地存储：", e);
				}
			}

			// ========== UI帮助 ==========
			function formatPrice(n) {
				const num = Number(n) || 0;
				return num.toFixed(2);
			}

			function makeId() {
				return "id_" + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
			}

			function updateSubcategoryOptions() {
				const cat = els.category.value;
				const subs = categoryToSub[cat] || [];
				els.subcategory.innerHTML = "";

				if (!cat) {
					els.subcategory.disabled = true;
					els.subcategory.innerHTML = '<option value="">先选择上方类别</option>';
					return;
				}

				if (subs.length === 0) {
					els.subcategory.disabled = true;
					els.subcategory.innerHTML = '<option value="">（无子类别）</option>';
				} else {
					els.subcategory.disabled = false;
					els.subcategory.appendChild(new Option("请选择", ""));
					subs.forEach(s => els.subcategory.appendChild(new Option(s, s)));
				}
			}

			els.category.addEventListener("change", updateSubcategoryOptions);

			// ========== 校验 ==========
			function validateInputs() {
				const name = els.itemName.value.trim();
				const category = els.category.value;
				const priceVal = els.price.value.trim();

				if (!name) {
					alert("请输入商品名称");
					return false;
				}
				if (!category) {
					alert("请选择需求类别");
					return false;
				}
				const priceNum = Number(priceVal);
				if (priceVal === "" || Number.isNaN(priceNum) || priceNum < 0) {
					alert("请输入有效的非负价格");
					return false;
				}
				return true;
			}

			// ========== 渲染 ==========
			function render() {
				els.listBody.innerHTML = "";
				items.forEach(renderRow);
				updateTotals();
			}

			function renderRow(item) {
				const tr = document.createElement("tr");
				tr.dataset.id = item.id;

				// 名称
				const tdName = document.createElement("td");
				tdName.textContent = item.name;

				// 类别
				const tdCat = document.createElement("td");
				tdCat.className = "row-category";
				tdCat.textContent = item.category;

				// 子类别
				const tdSub = document.createElement("td");
				tdSub.className = "row-subcategory";
				tdSub.textContent = item.subcategory || "—";

				// 价格
				const tdPrice = document.createElement("td");
				tdPrice.className = "price-cell";
				tdPrice.textContent = formatPrice(item.price);

				// 状态（可改）
				const tdStatus = document.createElement("td");
				const statusSelect = document.createElement("select");
				statusSelect.className = "row-status-select";
				[
					{ label: "待决策", value: "待决策" },
					{ label: "已购买", value: "已购买" },
					{ label: "已放弃", value: "已放弃" }
				].forEach(opt => statusSelect.appendChild(new Option(opt.label, opt.value)));
				statusSelect.value = item.status || "待决策";

				const statusBadge = document.createElement("span");
				statusBadge.className = "badge";
				statusBadge.style.marginLeft = "8px";
				function updateBadge(value) {
					statusBadge.className = "badge";
					if (value === "已购买") {
						statusBadge.classList.add("success");
					} else if (value === "待决策") {
						statusBadge.classList.add("muted");
					} else {
						statusBadge.classList.add("warning");
					}
					statusBadge.textContent = value;
				}
				updateBadge(statusSelect.value);

				statusSelect.addEventListener("change", (e) => {
					const v = e.target.value;
					updateBadge(v);
					updateItem(item.id, { status: v });
				});

				tdStatus.appendChild(statusSelect);
				tdStatus.appendChild(statusBadge);

				// 操作
				const tdActions = document.createElement("td");
				const delBtn = document.createElement("button");
				delBtn.textContent = "删除";
				delBtn.className = "danger";
				delBtn.addEventListener("click", () => {
					if (confirm("确认删除该条目吗？")) {
						deleteItem(item.id);
					}
				});
				tdActions.appendChild(delBtn);

				tr.appendChild(tdName);
				tr.appendChild(tdCat);
				tr.appendChild(tdSub);
				tr.appendChild(tdPrice);
				tr.appendChild(tdStatus);
				tr.appendChild(tdActions);

				els.listBody.appendChild(tr);
			}

			function updateTotals() {
				const purchased = items.filter(x => x.status === "已购买");
				const count = purchased.length;
				const total = purchased.reduce((sum, x) => sum + Number(x.price || 0), 0);
				els.purchasedCount.textContent = String(count);
				els.purchasedTotal.textContent = formatPrice(total);
			}

			// ========== 数据操作 ==========
			function addItem({ name, category, subcategory, price }) {
				const item = {
					id: makeId(),
					name,
					category,
					subcategory: subcategory || "",
					price: Number(price) || 0,
					status: "待决策"
				};
				items.push(item);
				saveData();
				render();
			}

			function updateItem(id, partial) {
				const idx = items.findIndex(x => x.id === id);
				if (idx >= 0) {
					items[idx] = { ...items[idx], ...partial };
					saveData();
					updateTotals();
				}
			}

			function deleteItem(id) {
				items = items.filter(x => x.id !== id);
				saveData();
				render();
			}

			// ========== 事件 ==========
			els.addBtn.addEventListener("click", () => {
				if (!validateInputs()) return;

				const payload = {
					name: els.itemName.value.trim(),
					category: els.category.value,
					subcategory: els.subcategory.disabled ? "" : (els.subcategory.value || ""),
					price: Number(els.price.value.trim())
				};
				addItem(payload);

				// 清空表单
				els.itemName.value = "";
				els.category.value = "";
				els.subcategory.innerHTML = '<option value="">先选择上方类别</option>';
				els.subcategory.disabled = true;
				els.price.value = "";
				els.itemName.focus();
			});

			// ========== 初始化 ==========
			function seedIfEmpty() {
				if (items.length > 0) return;
				const demoData = [
					{ name: "大米（10kg）", category: "刚需", subcategory: "每月必要支出", price: 68.9, status: "待决策" },
					{ name: "降噪耳机", category: "计划性需求", subcategory: "心愿单", price: 1299, status: "待决策" },
					{ name: "盲盒摆件", category: "冲动性需求", subcategory: "", price: 59, status: "待决策" }
				];
				items = demoData.map(d => ({ id: makeId(), ...d }));
				saveData();
			}

			items = loadData();
			seedIfEmpty();
			render();
		})();
	</script>
</body>
</html>